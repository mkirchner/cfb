<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrossFit Workout Builder</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: white;
            color: black;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            border-bottom: 2px solid black;
            padding-bottom: 15px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin: 0;
        }

        .workout-name {
            padding: 8px;
            border: 1px solid black;
            border-radius: 4px;
            font-size: 16px;
            flex: 1;
            max-width: 400px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .panel {
            padding: 20px;
        }

        .panel h2 {
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid black;
        }

        /* Superset Catalog Styles */
        .superset-catalog {
            padding: 0 0 20px 0;
            margin-bottom: 20px;
        }

        .superset-types {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .superset-type {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 14px;
            border: 1px solid black;
            border-radius: 16px;
            cursor: move;
            background: white;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .superset-type:hover {
            background: #f5f5f5;
        }

        .superset-type.dragging {
            opacity: 0.5;
        }

        /* Exercise Catalog Styles */
        .catalog {
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }

        .exercise-category {
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .category-icon {
            font-size: 20px;
        }

        .category-title {
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .exercise-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .exercise-pill {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border: 1px solid black;
            border-radius: 16px;
            cursor: move;
            background: white;
            font-size: 13px;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .exercise-pill:hover {
            background: #f5f5f5;
        }

        .exercise-pill.dragging {
            opacity: 0.5;
        }

        .exercise-pill.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            border-color: #ccc;
        }

        /* Workout Builder Styles */
        .workout-builder {
            min-height: 300px;
        }

        .drop-zone {
            min-height: 200px;
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .drop-zone.drag-over {
            background: #f5f5f5;
            border-color: black;
            border-style: solid;
        }

        .drop-zone-empty {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 14px;
        }

        /* Superset Container Styles */
        .superset-container {
            border: 2px solid black;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
            position: relative;
        }

        .superset-container::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            transition: background 0.2s;
        }

        .superset-container.drag-over-top::before {
            background: black;
            height: 4px;
        }

        .superset-container.dragging {
            opacity: 0.5;
        }

        .superset-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        .superset-drag-handle {
            cursor: move;
            color: #666;
            font-size: 18px;
            flex-shrink: 0;
        }

        .superset-title-input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid black;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 600;
        }

        .superset-title-input:focus {
            outline: 2px solid black;
        }

        .superset-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }

        .superset-config {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .superset-config-inline {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .superset-config-inline input {
            width: 50px;
            padding: 3px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 13px;
            text-align: center;
        }

        .superset-config-inline input:focus {
            outline: 1px solid black;
            border-color: black;
        }

        .superset-config-label {
            font-weight: 500;
        }

        .superset-exercises {
            min-height: 60px;
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }

        .superset-exercises.drag-over {
            background: #f5f5f5;
            border-color: black;
            border-style: solid;
        }

        .superset-exercises-empty {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 13px;
        }

        /* Workout Exercise Styles */
        .workout-exercise {
            border: 1px solid black;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 8px;
            background: white;
            cursor: move;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .workout-exercise::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 0;
            right: 0;
            height: 3px;
            background: transparent;
            transition: background 0.2s;
        }

        .workout-exercise.drag-over-top::before {
            background: black;
            height: 3px;
        }

        .workout-exercise.dragging {
            opacity: 0.5;
        }

        .workout-exercise .drag-handle {
            cursor: move;
            color: #666;
            font-size: 16px;
            flex-shrink: 0;
        }

        .workout-exercise .exercise-icon {
            font-size: 18px;
            flex-shrink: 0;
            width: 20px;
        }

        .workout-exercise .exercise-name {
            font-weight: 600;
            font-size: 14px;
            flex: 1;
            min-width: 0;
        }

        .workout-exercise-inline-input {
            width: 50px;
            padding: 4px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 13px;
            text-align: center;
        }

        .workout-exercise-inline-input:focus {
            outline: 1px solid black;
            border-color: black;
        }

        .exercise-inline-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .icon-btn {
            background: white;
            border: 1px solid black;
            border-radius: 3px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .icon-btn .material-icons-round {
            font-size: 16px;
        }

        .icon-btn:hover {
            background: #f5f5f5;
        }

        .config-field {
            display: flex;
            flex-direction: column;
        }

        .config-field label {
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .config-field input {
            padding: 6px;
            border: 1px solid black;
            border-radius: 4px;
            font-size: 14px;
        }

        .actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid black;
            border-radius: 4px;
            background: black;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn:hover {
            background: #333;
        }

        .btn-secondary {
            background: white;
            color: black;
        }

        .btn-secondary:hover {
            background: #f5f5f5;
        }

        input:focus {
            outline: 2px solid black;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Workout:</h1>
            <input type="text" class="workout-name" id="workoutName" placeholder="Workout name (e.g., WOD 2024-11-08)">
        </header>

        <div class="main-grid">
            <div class="panel workout-builder">
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-empty">Drag superset types here to build your workout</div>
                </div>
                <div class="actions">
                    <button class="btn" id="exportBtn">Export PDF</button>
                    <button class="btn btn-secondary" id="shareBtn">Share Workout</button>
                    <button class="btn btn-secondary" id="clearBtn">Clear Workout</button>
                </div>
            </div>

            <div class="panel">
                <div class="superset-catalog">
                    <h2>Supersets</h2>
                    <div class="superset-types" id="supersetTypes"></div>
                </div>

                <h2>Exercises</h2>
                <div class="catalog" id="catalog"></div>
            </div>
        </div>
    </div>

    <script>
        // Flat exercise catalog - append-only repository
        // Each exercise has: id (unique), name, class (category), visible (defaults to true)
        const exerciseCatalog = [
            // Cardio
            { id: 1, name: "Biking", class: "Cardio", visible: true },
            { id: 2, name: "Burpees", class: "Cardio", visible: true },
            { id: 54, name: "Box Burpees", class: "Cardio", visible: true },
            { id: 3, name: "Double Unders", class: "Cardio", visible: true },
            { id: 4, name: "Rope Jumps", class: "Cardio", visible: true },
            { id: 5, name: "Rowing", class: "Cardio", visible: true },
            { id: 6, name: "Running", class: "Cardio", visible: true },
            // Weightlifting
            { id: 7, name: "Back Squats", class: "Weightlifting", visible: true },
            { id: 8, name: "Clean & Jerk", class: "Weightlifting", visible: true },
            { id: 9, name: "Cleans", class: "Weightlifting", visible: true },
            { id: 10, name: "Deadlifts", class: "Weightlifting", visible: true },
            { id: 11, name: "Farmer's Walk", class: "Weightlifting", visible: true },
            { id: 12, name: "Front Squats", class: "Weightlifting", visible: true },
            { id: 13, name: "Goblet Squats", class: "Weightlifting", visible: true },
            { id: 14, name: "Hang Power Cleans", class: "Weightlifting", visible: true },
            { id: 15, name: "KB Cleans", class: "Weightlifting", visible: true },
            { id: 16, name: "KB Deadlifts", class: "Weightlifting", visible: true },
            { id: 17, name: "KB Halos", class: "Weightlifting", visible: true },
            { id: 18, name: "KB one-hand OH Squats", class: "Weightlifting", visible: true },
            { id: 19, name: "KB Presses", class: "Weightlifting", visible: true },
            { id: 20, name: "KB Rows", class: "Weightlifting", visible: true },
            { id: 21, name: "KB Snatches", class: "Weightlifting", visible: true },
            { id: 22, name: "KB Swings", class: "Weightlifting", visible: true },
            { id: 23, name: "Overhead Squats", class: "Weightlifting", visible: true },
            { id: 24, name: "Power Cleans", class: "Weightlifting", visible: true },
            { id: 25, name: "Push Presses", class: "Weightlifting", visible: true },
            { id: 26, name: "Shoulder Presses", class: "Weightlifting", visible: true },
            { id: 27, name: "Snatches", class: "Weightlifting", visible: true },
            { id: 28, name: "Sumo Deadlift High Pulls", class: "Weightlifting", visible: true },
            { id: 29, name: "Thrusters", class: "Weightlifting", visible: true },
            { id: 30, name: "Wall Balls", class: "Weightlifting", visible: true },
            // Gymnastics
            { id: 31, name: "Air Squats", class: "Gymnastics", visible: true },
            { id: 32, name: "Back Extensions", class: "Gymnastics", visible: true },
            { id: 33, name: "Back Lunges", class: "Gymnastics", visible: true },
            { id: 34, name: "Box Jumps", class: "Gymnastics", visible: true },
            { id: 35, name: "Bulgarian Lunges", class: "Gymnastics", visible: true },
            { id: 36, name: "Crunches", class: "Gymnastics", visible: true },
            { id: 37, name: "Dips", class: "Gymnastics", visible: true },
            { id: 38, name: "Handstand Push-Ups", class: "Gymnastics", visible: true },
            { id: 39, name: "High Knees", class: "Gymnastics", visible: true },
            { id: 40, name: "Jumping Lunges", class: "Gymnastics", visible: true },
            { id: 41, name: "Muscle Up", class: "Gymnastics", visible: true },
            { id: 42, name: "Pistols", class: "Gymnastics", visible: true },
            { id: 43, name: "Planks", class: "Gymnastics", visible: true },
            { id: 44, name: "Pull-Ups", class: "Gymnastics", visible: true },
            { id: 45, name: "Push-Ups", class: "Gymnastics", visible: true },
            { id: 46, name: "Ring Dips", class: "Gymnastics", visible: true },
            { id: 47, name: "Ring Rows", class: "Gymnastics", visible: true },
            { id: 48, name: "Side Planks", class: "Gymnastics", visible: true },
            { id: 49, name: "Sit-ups", class: "Gymnastics", visible: true },
            { id: 50, name: "Toes to Bar", class: "Gymnastics", visible: true },
            { id: 51, name: "Walking Lunges", class: "Gymnastics", visible: true },
            { id: 52, name: "Wall Walks", class: "Gymnastics", visible: true },
            // Other
            { id: 53, name: "Rest", class: "Other", visible: true }
        ];

        // Category icons mapping
        const categoryIcons = {
            "Cardio": "directions_run",
            "Weightlifting": "fitness_center",
            "Gymnastics": "sports_gymnastics",
            "Other": "sports"
        };

        // Build categorized exercise structure from flat catalog at runtime
        function buildExercisesByCategory() {
            const result = {};

            // Initialize categories with their icons
            for (const [category, icon] of Object.entries(categoryIcons)) {
                result[category] = {
                    icon: icon,
                    exercises: []
                };
            }

            // Populate with visible exercises from catalog
            for (const exercise of exerciseCatalog) {
                if (exercise.visible && result[exercise.class]) {
                    result[exercise.class].exercises.push(exercise.name);
                }
            }

            // Remove empty categories
            for (const category of Object.keys(result)) {
                if (result[category].exercises.length === 0) {
                    delete result[category];
                }
            }

            return result;
        }

        // Runtime categorized structure
        const exercises = buildExercisesByCategory();

        const supersetTypes = [
            {
                name: "For Time",
                fields: ["rounds", "timeEstimate"],
                defaults: { rounds: "", timeEstimate: "" },
                format: (config) => `${config.rounds || '_'}x For Time${config.timeEstimate ? ` ca. ${config.timeEstimate} min` : ''}`
            },
            {
                name: "AMRAP",
                fields: ["duration"],
                defaults: { duration: "" },
                format: (config) => `${config.duration || '_'} min AMRAP`
            },
            {
                name: "EMOM",
                fields: ["duration", "interval"],
                defaults: { duration: "", interval: "1" },
                format: (config) => `${config.duration || '_'} min EMOM (every ${config.interval || '1'} min)`
            },
            {
                name: "Chipper",
                fields: ["timeEstimate"],
                defaults: { timeEstimate: "" },
                format: (config) => `Chipper${config.timeEstimate ? ` ca. ${config.timeEstimate} min` : ''}`
            },
            {
                name: "Sequence",
                fields: ["sequence", "timeEstimate"],
                defaults: { sequence: "", timeEstimate: "" },
                format: (config) => `${config.sequence || '_'} Sequence${config.timeEstimate ? ` ca. ${config.timeEstimate} min` : ''}`
            }
        ];

        let workoutSupersets = [];
        let supersetCounter = 0;
        let exerciseCounter = 0;

        // Drag state variables
        let draggedExerciseId = null;
        let draggedSupersetId = null;
        let draggedFromCatalog = false;
        let catalogExerciseData = null;
        let draggedSupersetType = null;

        function renderSupersetTypes() {
            const container = document.getElementById('supersetTypes');
            container.innerHTML = '';

            supersetTypes.forEach(type => {
                const div = document.createElement('div');
                div.className = 'superset-type';
                div.draggable = true;
                div.dataset.supersetType = JSON.stringify(type);
                div.textContent = type.name;

                div.addEventListener('dragstart', handleSupersetTypeDragStart);
                div.addEventListener('dragend', handleSupersetTypeDragEnd);

                container.appendChild(div);
            });
        }

        function renderCatalog() {
            const catalog = document.getElementById('catalog');
            catalog.innerHTML = '';

            const hasSupersetsInBuilder = workoutSupersets.length > 0;

            for (const [category, data] of Object.entries(exercises)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'exercise-category';

                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerHTML = `
                    <span class="material-icons-round category-icon">${data.icon}</span>
                    <span class="category-title">${category}</span>
                `;
                categoryDiv.appendChild(header);

                const pillsContainer = document.createElement('div');
                pillsContainer.className = 'exercise-pills';

                data.exercises.forEach(exerciseName => {
                    const pill = document.createElement('div');
                    pill.className = 'exercise-pill';
                    if (!hasSupersetsInBuilder) {
                        pill.classList.add('disabled');
                    } else {
                        pill.draggable = true;
                        pill.dataset.exercise = JSON.stringify({ name: exerciseName, category: category, icon: data.icon });
                        pill.addEventListener('dragstart', handleCatalogDragStart);
                        pill.addEventListener('dragend', handleCatalogDragEnd);
                    }
                    pill.textContent = exerciseName;

                    pillsContainer.appendChild(pill);
                });

                categoryDiv.appendChild(pillsContainer);
                catalog.appendChild(categoryDiv);
            }
        }

        // Superset Type Drag Handlers
        function handleSupersetTypeDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
            draggedSupersetType = JSON.parse(e.target.dataset.supersetType);
        }

        function handleSupersetTypeDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedSupersetType = null;
        }

        // Catalog Drag Handlers
        function handleCatalogDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
            draggedFromCatalog = true;
            draggedExerciseId = null;
            draggedSupersetId = null;
            catalogExerciseData = JSON.parse(e.target.dataset.exercise);
        }

        function handleCatalogDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedFromCatalog = false;
            catalogExerciseData = null;
        }

        // Drop Zone Handlers
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            
            if (draggedSupersetType) {
                // Dropping a superset type
                const supersetElements = Array.from(dropZone.querySelectorAll('.superset-container'));
                const isOverSuperset = supersetElements.some(el => {
                    const rect = el.getBoundingClientRect();
                    return e.clientY >= rect.top && e.clientY <= rect.bottom;
                });
                
                if (!isOverSuperset) {
                    e.dataTransfer.dropEffect = 'copy';
                    dropZone.classList.add('drag-over');
                } else {
                    dropZone.classList.remove('drag-over');
                }
            }
        });

        dropZone.addEventListener('dragleave', (e) => {
            if (!dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('drag-over');
            }
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            if (draggedSupersetType) {
                // Check if dropped on empty space
                const supersetElements = Array.from(dropZone.querySelectorAll('.superset-container'));
                const isOverSuperset = supersetElements.some(el => {
                    const rect = el.getBoundingClientRect();
                    return e.clientY >= rect.top && e.clientY <= rect.bottom;
                });
                
                if (!isOverSuperset) {
                    addSupersetToWorkout(draggedSupersetType);
                }
            }
        });

        function addSupersetToWorkout(type) {
            const newSuperset = {
                id: supersetCounter++,
                type: type,
                title: '',
                config: { ...type.defaults },
                exercises: []
            };
            workoutSupersets.push(newSuperset);
            renderWorkout();
            debouncedUpdateURL();
        }

        function renderWorkout() {
            const empty = dropZone.querySelector('.drop-zone-empty');
            
            if (workoutSupersets.length === 0) {
                if (!empty) {
                    dropZone.innerHTML = '<div class="drop-zone-empty">Drag superset types here to build your workout</div>';
                }
                renderCatalog(); // Re-render to disable exercises
                return;
            }

            if (empty) {
                empty.remove();
            }

            const existingSupersets = dropZone.querySelectorAll('.superset-container');
            existingSupersets.forEach(el => el.remove());

            workoutSupersets.forEach((superset) => {
                const supersetDiv = document.createElement('div');
                supersetDiv.className = 'superset-container';
                supersetDiv.draggable = true;
                supersetDiv.dataset.supersetId = superset.id;

                // Build config HTML inline
                let configHTML = '<div class="superset-config">';
                
                if (superset.type.name === 'For Time') {
                    configHTML += `
                        <div class="superset-config-inline">
                            <input type="text" value="${superset.config.rounds || ''}" 
                                   onchange="updateSupersetConfig(${superset.id}, 'rounds', this.value)"
                                   placeholder="5">
                            <span>x For Time</span>
                        </div>
                    `;
                    configHTML += `
                        <div class="superset-config-inline">
                            <span>ca.</span>
                            <input type="text" value="${superset.config.timeEstimate || ''}" 
                                   onchange="updateSupersetConfig(${superset.id}, 'timeEstimate', this.value)"
                                   placeholder="18">
                            <span>min</span>
                        </div>
                    `;
                } else if (superset.type.name === 'AMRAP') {
                    configHTML += `
                        <div class="superset-config-inline">
                            <input type="text" value="${superset.config.duration || ''}" 
                                   onchange="updateSupersetConfig(${superset.id}, 'duration', this.value)"
                                   placeholder="5">
                            <span>min AMRAP</span>
                        </div>
                    `;
                } else if (superset.type.name === 'EMOM') {
                    configHTML += `
                        <div class="superset-config-inline">
                            <input type="text" value="${superset.config.duration || ''}" 
                                   onchange="updateSupersetConfig(${superset.id}, 'duration', this.value)"
                                   placeholder="20">
                            <span>min EMOM (every</span>
                            <input type="text" value="${superset.config.interval || ''}" 
                                   onchange="updateSupersetConfig(${superset.id}, 'interval', this.value)"
                                   placeholder="1">
                            <span>min)</span>
                        </div>
                    `;
                } else if (superset.type.name === 'Chipper') {
                    configHTML += `
                        <span>Chipper</span>
                        <div class="superset-config-inline">
                            <span>ca.</span>
                            <input type="text" value="${superset.config.timeEstimate || ''}"
                                   onchange="updateSupersetConfig(${superset.id}, 'timeEstimate', this.value)"
                                   placeholder="15">
                            <span>min</span>
                        </div>
                    `;
                } else if (superset.type.name === 'Sequence') {
                    configHTML += `
                        <div class="superset-config-inline">
                            <input type="text" value="${superset.config.sequence || ''}"
                                   onchange="updateSupersetConfig(${superset.id}, 'sequence', this.value)"
                                   placeholder="21-15-9"
                                   style="width: 80px;">
                            <span>Sequence</span>
                        </div>
                    `;
                    configHTML += `
                        <div class="superset-config-inline">
                            <span>ca.</span>
                            <input type="text" value="${superset.config.timeEstimate || ''}"
                                   onchange="updateSupersetConfig(${superset.id}, 'timeEstimate', this.value)"
                                   placeholder="15">
                            <span>min</span>
                        </div>
                    `;
                }

                configHTML += '</div>';

                supersetDiv.innerHTML = `
                    <div class="superset-header">
                        <span class="superset-drag-handle">⋮⋮</span>
                        <input type="text" class="superset-title-input" 
                               value="${superset.title || ''}"
                               onchange="updateSupersetTitle(${superset.id}, this.value)"
                               placeholder="Superset name">
                        <div class="superset-actions">
                            <button class="icon-btn" onclick="removeSuperset(${superset.id})" title="Remove">
                                <span class="material-icons-round">delete</span>
                            </button>
                        </div>
                    </div>
                    ${configHTML}
                    <div class="superset-exercises" data-superset-id="${superset.id}">
                        ${superset.exercises.length === 0 ? '<div class="superset-exercises-empty">Drag exercises here</div>' : ''}
                    </div>
                `;

                supersetDiv.addEventListener('dragstart', handleSupersetDragStart);
                supersetDiv.addEventListener('dragend', handleSupersetDragEnd);
                supersetDiv.addEventListener('dragover', handleSupersetDragOver);
                supersetDiv.addEventListener('drop', handleSupersetDrop);
                supersetDiv.addEventListener('dragleave', handleSupersetDragLeave);

                dropZone.appendChild(supersetDiv);

                const exercisesContainer = supersetDiv.querySelector('.superset-exercises');
                
                superset.exercises.forEach((exercise) => {
                    const exerciseDiv = document.createElement('div');
                    exerciseDiv.className = 'workout-exercise';
                    exerciseDiv.draggable = true;
                    exerciseDiv.dataset.exerciseId = exercise.id;
                    exerciseDiv.dataset.supersetId = superset.id;

                    exerciseDiv.innerHTML = `
                        <span class="drag-handle">⋮⋮</span>
                        <input type="text" class="workout-exercise-inline-input" 
                               value="${exercise.reps || ''}"
                               onchange="updateExercise(${superset.id}, ${exercise.id}, 'reps', this.value)"
                               placeholder="10">
                        <span class="material-icons-round exercise-icon">${exercise.icon}</span>
                        <span class="exercise-name">${exercise.name}</span>
                        <input type="text" class="workout-exercise-inline-input" 
                               value="${exercise.weight || ''}"
                               onchange="updateExercise(${superset.id}, ${exercise.id}, 'weight', this.value)"
                               placeholder="135">
                        <div class="exercise-inline-actions">
                            <button class="icon-btn" onclick="duplicateExercise(${superset.id}, ${exercise.id})" title="Duplicate">
                                <span class="material-icons-round">content_copy</span>
                            </button>
                            <button class="icon-btn" onclick="removeExercise(${superset.id}, ${exercise.id})" title="Remove">
                                <span class="material-icons-round">delete</span>
                            </button>
                        </div>
                    `;

                    exerciseDiv.addEventListener('dragstart', handleExerciseDragStart);
                    exerciseDiv.addEventListener('dragend', handleExerciseDragEnd);
                    exerciseDiv.addEventListener('dragover', handleExerciseDragOver);
                    exerciseDiv.addEventListener('drop', handleExerciseDrop);
                    exerciseDiv.addEventListener('dragleave', handleExerciseDragLeave);

                    if (exercisesContainer.querySelector('.superset-exercises-empty')) {
                        exercisesContainer.innerHTML = '';
                    }
                    exercisesContainer.appendChild(exerciseDiv);
                });

                exercisesContainer.addEventListener('dragover', handleExercisesContainerDragOver);
                exercisesContainer.addEventListener('drop', handleExercisesContainerDrop);
                exercisesContainer.addEventListener('dragleave', handleExercisesContainerDragLeave);
            });

            // Re-render catalog to enable exercises now that supersets exist
            renderCatalog();
        }

        function getFieldPlaceholder(field) {
            const placeholders = {
                'rounds': 'e.g., 3',
                'duration': 'minutes',
                'interval': 'minutes',
                'timeEstimate': 'minutes'
            };
            return placeholders[field] || '';
        }

        // Superset Drag Handlers
        function handleSupersetDragStart(e) {
            if (!e.target.classList.contains('superset-container')) return;
            draggedSupersetId = parseInt(e.currentTarget.dataset.supersetId);
            draggedExerciseId = null;
            draggedFromCatalog = false;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.stopPropagation();
        }

        function handleSupersetDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.superset-container').forEach(el => {
                el.classList.remove('drag-over-top');
            });
            draggedSupersetId = null;
        }

        function handleSupersetDragOver(e) {
            if (draggedSupersetId === null) return;
            e.preventDefault();
            e.stopPropagation();
            
            const rect = e.currentTarget.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            
            document.querySelectorAll('.superset-container').forEach(el => {
                el.classList.remove('drag-over-top');
            });
            
            if (e.clientY < midpoint) {
                e.currentTarget.classList.add('drag-over-top');
            }
            
            e.dataTransfer.dropEffect = 'move';
        }

        function handleSupersetDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drag-over-top');
            }
        }

        function handleSupersetDrop(e) {
            if (draggedSupersetId === null) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const dropTarget = e.currentTarget;
            const targetId = parseInt(dropTarget.dataset.supersetId);
            
            if (draggedSupersetId === targetId) {
                dropTarget.classList.remove('drag-over-top');
                return;
            }
            
            const rect = dropTarget.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            const dropBefore = e.clientY < midpoint;
            
            dropTarget.classList.remove('drag-over-top');
            
            const draggedIndex = workoutSupersets.findIndex(s => s.id === draggedSupersetId);
            const [removed] = workoutSupersets.splice(draggedIndex, 1);
            
            const newTargetIndex = workoutSupersets.findIndex(s => s.id === targetId);
            const insertIndex = dropBefore ? newTargetIndex : newTargetIndex + 1;
            
            workoutSupersets.splice(insertIndex, 0, removed);
            renderWorkout();
            debouncedUpdateURL();
        }

        // Exercise Drag Handlers
        function handleExerciseDragStart(e) {
            if (!e.target.classList.contains('workout-exercise')) return;
            draggedExerciseId = parseInt(e.currentTarget.dataset.exerciseId);
            draggedSupersetId = null;
            draggedFromCatalog = false;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.stopPropagation();
        }

        function handleExerciseDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.workout-exercise').forEach(el => {
                el.classList.remove('drag-over-top');
            });
            document.querySelectorAll('.superset-exercises').forEach(el => {
                el.classList.remove('drag-over');
            });
            draggedExerciseId = null;
        }

        function handleExerciseDragOver(e) {
            if (draggedExerciseId === null && !draggedFromCatalog) return;
            e.preventDefault();
            e.stopPropagation();
            
            const rect = e.currentTarget.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            
            document.querySelectorAll('.workout-exercise').forEach(el => {
                el.classList.remove('drag-over-top');
            });
            
            if (e.clientY < midpoint) {
                e.currentTarget.classList.add('drag-over-top');
            }
            
            e.dataTransfer.dropEffect = draggedFromCatalog ? 'copy' : 'move';
        }

        function handleExerciseDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drag-over-top');
            }
        }

        function handleExerciseDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropTarget = e.currentTarget;
            const targetExerciseId = parseInt(dropTarget.dataset.exerciseId);
            const targetSupersetId = parseInt(dropTarget.dataset.supersetId);
            const targetSuperset = workoutSupersets.find(s => s.id === targetSupersetId);
            
            if (!targetSuperset) return;
            
            const rect = dropTarget.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            const dropBefore = e.clientY < midpoint;
            
            dropTarget.classList.remove('drag-over-top');
            
            const targetIndex = targetSuperset.exercises.findIndex(ex => ex.id === targetExerciseId);
            
            if (draggedFromCatalog && catalogExerciseData) {
                const newExercise = {
                    id: exerciseCounter++,
                    ...catalogExerciseData,
                    reps: '',
                    weight: ''
                };
                
                const insertIndex = dropBefore ? targetIndex : targetIndex + 1;
                targetSuperset.exercises.splice(insertIndex, 0, newExercise);
                
            } else if (draggedExerciseId !== null) {
                let sourceSuperset = null;
                let sourceExercise = null;
                let sourceIndex = -1;
                
                for (const superset of workoutSupersets) {
                    const index = superset.exercises.findIndex(ex => ex.id === draggedExerciseId);
                    if (index !== -1) {
                        sourceSuperset = superset;
                        sourceExercise = superset.exercises[index];
                        sourceIndex = index;
                        break;
                    }
                }
                
                if (!sourceSuperset || !sourceExercise) return;
                
                sourceSuperset.exercises.splice(sourceIndex, 1);
                
                let newTargetIndex = targetIndex;
                if (sourceSuperset.id === targetSupersetId && sourceIndex < targetIndex) {
                    newTargetIndex--;
                }
                
                const insertIndex = dropBefore ? newTargetIndex : newTargetIndex + 1;
                targetSuperset.exercises.splice(insertIndex, 0, sourceExercise);
            }

            renderWorkout();
            debouncedUpdateURL();
        }

        // Exercise Container Drag Handlers
        function handleExercisesContainerDragOver(e) {
            if (!draggedFromCatalog || !catalogExerciseData) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const container = e.currentTarget;
            const exercises = Array.from(container.querySelectorAll('.workout-exercise'));
            
            const isOverExercise = exercises.some(el => {
                const rect = el.getBoundingClientRect();
                return e.clientY >= rect.top && e.clientY <= rect.bottom;
            });
            
            if (!isOverExercise) {
                container.classList.add('drag-over');
            } else {
                container.classList.remove('drag-over');
            }
        }

        function handleExercisesContainerDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drag-over');
            }
        }

        function handleExercisesContainerDrop(e) {
            if (!draggedFromCatalog || !catalogExerciseData) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const container = e.currentTarget;
            container.classList.remove('drag-over');
            
            const supersetId = parseInt(container.dataset.supersetId);
            const superset = workoutSupersets.find(s => s.id === supersetId);
            
            if (!superset) return;
            
            const exercises = Array.from(container.querySelectorAll('.workout-exercise'));
            const isOverExercise = exercises.some(el => {
                const rect = el.getBoundingClientRect();
                return e.clientY >= rect.top && e.clientY <= rect.bottom;
            });
            
            if (!isOverExercise) {
                const newExercise = {
                    id: exerciseCounter++,
                    ...catalogExerciseData,
                    reps: '',
                    weight: ''
                };
                superset.exercises.push(newExercise);
                renderWorkout();
                debouncedUpdateURL();
            }
        }

        // Update/Remove Functions
        function updateSupersetTitle(supersetId, value) {
            const superset = workoutSupersets.find(s => s.id === supersetId);
            if (superset) {
                superset.title = value;
                debouncedUpdateURL();
            }
        }

        function updateSupersetConfig(supersetId, field, value) {
            const superset = workoutSupersets.find(s => s.id === supersetId);
            if (superset) {
                superset.config[field] = value;
                debouncedUpdateURL();
            }
        }

        function removeSuperset(supersetId) {
            workoutSupersets = workoutSupersets.filter(s => s.id !== supersetId);
            renderWorkout();
            debouncedUpdateURL();
        }

        function updateExercise(supersetId, exerciseId, field, value) {
            const superset = workoutSupersets.find(s => s.id === supersetId);
            if (superset) {
                const exercise = superset.exercises.find(ex => ex.id === exerciseId);
                if (exercise) {
                    exercise[field] = value;
                    debouncedUpdateURL();
                }
            }
        }

        function removeExercise(supersetId, exerciseId) {
            const superset = workoutSupersets.find(s => s.id === supersetId);
            if (superset) {
                superset.exercises = superset.exercises.filter(ex => ex.id !== exerciseId);
                renderWorkout();
                debouncedUpdateURL();
            }
        }

        function duplicateExercise(supersetId, exerciseId) {
            const superset = workoutSupersets.find(s => s.id === supersetId);
            if (superset) {
                const exercise = superset.exercises.find(ex => ex.id === exerciseId);
                if (exercise) {
                    const newExercise = {
                        ...exercise,
                        id: exerciseCounter++
                    };
                    const index = superset.exercises.findIndex(ex => ex.id === exerciseId);
                    superset.exercises.splice(index + 1, 0, newExercise);
                    renderWorkout();
                    debouncedUpdateURL();
                }
            }
        }

        // URL Encoding/Decoding Functions

        // Convert to compact format for smaller URLs
        function toCompactFormat(workoutData) {
            return {
                v: 2, // version 2 (compressed)
                n: workoutData.name || '',
                s: workoutData.supersets.map(ss => {
                    const compact = {
                        i: ss.id,
                        t: supersetTypes.findIndex(t => t.name === ss.type.name), // type index
                        c: {} // only non-empty config values
                    };

                    // Only include non-empty title
                    if (ss.title) compact.ti = ss.title;

                    // Only include non-default config values
                    for (const [key, value] of Object.entries(ss.config)) {
                        if (value !== '' && value !== ss.type.defaults[key]) {
                            compact.c[key] = value;
                        }
                    }

                    // Compact exercises
                    compact.e = ss.exercises.map(ex => {
                        const compactEx = {
                            i: ex.id,
                            n: ex.name,
                            ic: ex.icon
                        };
                        // Only include non-empty values
                        if (ex.reps) compactEx.r = ex.reps;
                        if (ex.weight) compactEx.w = ex.weight;
                        if (ex.category) compactEx.c = ex.category;
                        return compactEx;
                    });

                    return compact;
                })
            };
        }

        // Convert from compact format back to full format
        function fromCompactFormat(compact) {
            // Handle old uncompressed format (no version field)
            if (!compact.v) {
                return compact;
            }

            return {
                name: compact.n || '',
                supersets: compact.s.map(ss => {
                    const type = supersetTypes[ss.t];
                    return {
                        id: ss.i,
                        type: type,
                        title: ss.ti || '',
                        config: { ...type.defaults, ...ss.c },
                        exercises: ss.e.map(ex => ({
                            id: ex.i,
                            name: ex.n,
                            icon: ex.ic,
                            reps: ex.r || '',
                            weight: ex.w || '',
                            category: ex.c
                        }))
                    };
                })
            };
        }

        function encodeWorkoutToURL() {
            const workoutName = document.getElementById('workoutName').value;
            const workoutData = {
                name: workoutName,
                supersets: workoutSupersets
            };

            try {
                // Convert to compact format
                const compact = toCompactFormat(workoutData);
                const json = JSON.stringify(compact);

                // Compress using pako
                const compressed = pako.deflate(json, { level: 9 });

                // Convert to base64
                const binary = String.fromCharCode.apply(null, compressed);
                let encoded = btoa(binary)
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=+$/, ''); // URL-safe base64

                // Insert '*' every 250 characters to prevent link breaking in messaging apps
                // This helps with iMessage and other apps that have issues with long URLs
                const chunkSize = 250;
                if (encoded.length > chunkSize) {
                    const chunks = [];
                    for (let i = 0; i < encoded.length; i += chunkSize) {
                        chunks.push(encoded.substring(i, i + chunkSize));
                    }
                    encoded = chunks.join('*');
                }

                return encoded;
            } catch (e) {
                console.error('Error encoding workout:', e);
                return null;
            }
        }

        function decodeWorkoutFromURL(encoded) {
            try {
                // Remove asterisk separators that were added every 250 characters
                const cleanEncoded = encoded.replace(/\*/g, '');

                // First, try new compressed format with URL-safe base64
                try {
                    // Restore standard base64
                    const base64 = cleanEncoded
                        .replace(/-/g, '+')
                        .replace(/_/g, '/');

                    // Pad if necessary
                    const padded = base64 + '=='.substring(0, (4 - base64.length % 4) % 4);

                    // Decode base64 to binary
                    const binary = atob(padded);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) {
                        bytes[i] = binary.charCodeAt(i);
                    }

                    // Decompress
                    const decompressed = pako.inflate(bytes, { to: 'string' });
                    const compact = JSON.parse(decompressed);

                    // Convert from compact format
                    return fromCompactFormat(compact);
                } catch (compressedError) {
                    // Fallback to old uncompressed format
                    const json = decodeURIComponent(atob(cleanEncoded));
                    return JSON.parse(json);
                }
            } catch (e) {
                console.error('Error decoding workout:', e);
                return null;
            }
        }

        function updateURL() {
            if (workoutSupersets.length === 0) {
                // Clear query parameter if workout is empty
                const url = new URL(window.location.href);
                if (url.searchParams.has('w')) {
                    url.searchParams.delete('w');
                    history.replaceState(null, '', url.pathname + (url.search || ''));
                }
                return;
            }

            const encoded = encodeWorkoutToURL();
            if (encoded) {
                const url = new URL(window.location.href);
                url.searchParams.set('w', encoded);
                history.replaceState(null, '', url.pathname + url.search);
            }
        }

        // Debounced URL update - waits 500ms after last change
        let urlUpdateTimeout = null;
        function debouncedUpdateURL() {
            if (urlUpdateTimeout) {
                clearTimeout(urlUpdateTimeout);
            }
            urlUpdateTimeout = setTimeout(() => {
                updateURL();
            }, 500);
        }

        function loadWorkoutFromURL() {
            // Try to get workout from query parameter first (new format)
            const url = new URL(window.location.href);
            let encoded = url.searchParams.get('w');

            // Fallback to hash for backward compatibility (old format)
            if (!encoded && window.location.hash) {
                encoded = window.location.hash.substring(1);
            }

            if (!encoded) return false;

            const workoutData = decodeWorkoutFromURL(encoded);
            if (!workoutData) return false;

            try {
                // Restore workout name
                if (workoutData.name) {
                    document.getElementById('workoutName').value = workoutData.name;
                }

                // Restore supersets
                if (workoutData.supersets && Array.isArray(workoutData.supersets)) {
                    workoutSupersets = workoutData.supersets;

                    // Update counters to avoid ID conflicts
                    supersetCounter = Math.max(...workoutSupersets.map(s => s.id), -1) + 1;

                    const allExerciseIds = workoutSupersets.flatMap(s =>
                        s.exercises.map(e => e.id)
                    );
                    exerciseCounter = allExerciseIds.length > 0 ? Math.max(...allExerciseIds) + 1 : 0;

                    renderWorkout();

                    // If loaded from hash, migrate to query parameter
                    if (window.location.hash && !url.searchParams.has('w')) {
                        updateURL();
                    }

                    return true;
                }
            } catch (e) {
                console.error('Error loading workout from URL:', e);
            }

            return false;
        }

        // Button Handlers
        document.getElementById('clearBtn').addEventListener('click', () => {
            if (workoutSupersets.length === 0 || confirm('Clear all supersets from workout?')) {
                workoutSupersets = [];
                renderWorkout();
                updateURL();
            }
        });

        document.getElementById('shareBtn').addEventListener('click', () => {
            if (workoutSupersets.length === 0) {
                alert('Add workout types and exercises before sharing');
                return;
            }

            // Force immediate URL update
            updateURL();

            // Copy URL to clipboard
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                const btn = document.getElementById('shareBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Link Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy URL:', err);
                // Fallback: show URL in prompt
                prompt('Copy this URL to share your workout:', url);
            });
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            if (workoutSupersets.length === 0) {
                alert('Add workout types and exercises before exporting');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const workoutName = document.getElementById('workoutName').value || 'CrossFit Workout';
            const date = new Date().toLocaleDateString();
            
            // Header
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.text(workoutName, 20, 20);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(date, 20, 28);
            
            doc.setLineWidth(0.5);
            doc.line(20, 32, 190, 32);
            
            let y = 45;
            
            workoutSupersets.forEach((superset, supersetIndex) => {
                if (y > 250) {
                    doc.addPage();
                    y = 25;
                }
                
                // Superset title
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                const title = superset.title || `Part ${supersetIndex + 1}`;
                doc.text(title, 20, y);
                y += 8;
                
                // Superset type description
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                let description = '';
                
                if (superset.type.name === 'For Time') {
                    const rounds = superset.config.rounds || '_';
                    const time = superset.config.timeEstimate;
                    description = `${rounds}x For Time${time ? ` ca. ${time} min` : ''}`;
                } else if (superset.type.name === 'AMRAP') {
                    const duration = superset.config.duration || '_';
                    description = `${duration} min AMRAP`;
                } else if (superset.type.name === 'EMOM') {
                    const duration = superset.config.duration || '_';
                    const interval = superset.config.interval || '1';
                    description = `${duration} min EMOM (every ${interval} min)`;
                } else if (superset.type.name === 'Chipper') {
                    const time = superset.config.timeEstimate;
                    description = `Chipper${time ? ` ca. ${time} min` : ''}`;
                } else if (superset.type.name === 'Sequence') {
                    const sequence = superset.config.sequence || '_';
                    const time = superset.config.timeEstimate;
                    description = `${sequence} Sequence${time ? ` ca. ${time} min` : ''}`;
                }

                doc.text(description, 20, y);
                y += 10;
                
                // Table header
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Reps', 25, y);
                doc.text('Weight', 55, y);
                doc.text('Exercise', 95, y);
                y += 2;
                
                // Line under header
                doc.setLineWidth(0.3);
                doc.line(20, y, 190, y);
                y += 6;
                
                // Exercise rows
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
                
                superset.exercises.forEach((exercise, exerciseIndex) => {
                    if (y > 275) {
                        doc.addPage();
                        y = 25;
                    }
                    
                    // Reps
                    doc.text(exercise.reps || '-', 25, y);
                    
                    // Weight
                    doc.text(exercise.weight || '-', 55, y);
                    
                    // Exercise name
                    doc.text(exercise.name, 95, y);
                    
                    y += 7;
                });
                
                y += 10; // Space between supersets
            });
            
            doc.save(`${workoutName.replace(/\s+/g, '-').toLowerCase()}.pdf`);
        });

        // Workout name change listener
        document.getElementById('workoutName').addEventListener('input', () => {
            debouncedUpdateURL();
        });

        // Touch Support Implementation
        let touchState = {
            active: false,
            clone: null,
            startX: 0,
            startY: 0,
            currentX: 0,
            currentY: 0,
            type: null, // 'superset-type', 'exercise-pill', 'superset', 'exercise'
            data: null,
            sourceElement: null
        };

        function createTouchClone(element, x, y) {
            const clone = element.cloneNode(true);
            clone.style.position = 'fixed';
            clone.style.left = x + 'px';
            clone.style.top = y + 'px';
            clone.style.opacity = '0.8';
            clone.style.pointerEvents = 'none';
            clone.style.zIndex = '10000';
            clone.style.transform = 'scale(1.05)';
            clone.style.transition = 'none';
            document.body.appendChild(clone);
            return clone;
        }

        function updateTouchClone(x, y) {
            if (touchState.clone) {
                touchState.clone.style.left = x + 'px';
                touchState.clone.style.top = y + 'px';
            }
        }

        function removeTouchClone() {
            if (touchState.clone) {
                touchState.clone.remove();
                touchState.clone = null;
            }
        }

        function getTouchPoint(e) {
            return e.touches && e.touches.length > 0 ? e.touches[0] : e.changedTouches[0];
        }

        function getElementAtPoint(x, y) {
            // Temporarily hide the clone to get the element underneath
            if (touchState.clone) {
                touchState.clone.style.display = 'none';
            }
            const element = document.elementFromPoint(x, y);
            if (touchState.clone) {
                touchState.clone.style.display = 'block';
            }
            return element;
        }

        function handleTouchStart(e, type, sourceElement) {
            if (e.touches.length > 1) return; // Only single touch

            e.preventDefault();
            e.stopPropagation();

            const touch = getTouchPoint(e);
            touchState.active = true;
            touchState.startX = touch.clientX;
            touchState.startY = touch.clientY;
            touchState.currentX = touch.clientX;
            touchState.currentY = touch.clientY;
            touchState.type = type;
            touchState.sourceElement = sourceElement;

            // Store data based on type
            if (type === 'superset-type') {
                touchState.data = JSON.parse(sourceElement.dataset.supersetType);
            } else if (type === 'exercise-pill') {
                touchState.data = JSON.parse(sourceElement.dataset.exercise);
            } else if (type === 'superset') {
                touchState.data = parseInt(sourceElement.dataset.supersetId);
            } else if (type === 'exercise') {
                touchState.data = {
                    exerciseId: parseInt(sourceElement.dataset.exerciseId),
                    supersetId: parseInt(sourceElement.dataset.supersetId)
                };
            }

            // Add visual feedback to source
            sourceElement.style.opacity = '0.5';
        }

        function handleTouchMove(e) {
            if (!touchState.active) return;

            e.preventDefault(); // Prevent scrolling

            const touch = getTouchPoint(e);
            touchState.currentX = touch.clientX;
            touchState.currentY = touch.clientY;

            // Create clone on first move (if dragged more than 5px)
            const dx = touchState.currentX - touchState.startX;
            const dy = touchState.currentY - touchState.startY;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (!touchState.clone && distance > 5) {
                touchState.clone = createTouchClone(
                    touchState.sourceElement,
                    touchState.currentX - touchState.sourceElement.offsetWidth / 2,
                    touchState.currentY - touchState.sourceElement.offsetHeight / 2
                );
            }

            if (touchState.clone) {
                updateTouchClone(
                    touchState.currentX - touchState.clone.offsetWidth / 2,
                    touchState.currentY - touchState.clone.offsetHeight / 2
                );
            }

            // Update drop indicators
            updateTouchDropIndicators(touchState.currentX, touchState.currentY);
        }

        function updateTouchDropIndicators(x, y) {
            // Clear all drop indicators
            document.querySelectorAll('.superset-container').forEach(el => {
                el.classList.remove('drag-over-top');
            });
            document.querySelectorAll('.workout-exercise').forEach(el => {
                el.classList.remove('drag-over-top');
            });
            document.querySelectorAll('.superset-exercises').forEach(el => {
                el.classList.remove('drag-over');
            });
            dropZone.classList.remove('drag-over');

            const element = getElementAtPoint(x, y);
            if (!element) return;

            // Handle different drop target types
            if (touchState.type === 'superset-type') {
                // Dropping on main drop zone
                const supersetContainer = element.closest('.superset-container');
                if (!supersetContainer && element.closest('.drop-zone')) {
                    dropZone.classList.add('drag-over');
                } else if (supersetContainer) {
                    const rect = supersetContainer.getBoundingClientRect();
                    const midpoint = rect.top + rect.height / 2;
                    if (y < midpoint) {
                        supersetContainer.classList.add('drag-over-top');
                    }
                }
            } else if (touchState.type === 'exercise-pill') {
                // Dropping on superset exercises container
                const exerciseElement = element.closest('.workout-exercise');
                const exercisesContainer = element.closest('.superset-exercises');

                if (exerciseElement) {
                    const rect = exerciseElement.getBoundingClientRect();
                    const midpoint = rect.top + rect.height / 2;
                    if (y < midpoint) {
                        exerciseElement.classList.add('drag-over-top');
                    }
                } else if (exercisesContainer && !exerciseElement) {
                    exercisesContainer.classList.add('drag-over');
                }
            } else if (touchState.type === 'superset') {
                // Reordering supersets
                const supersetContainer = element.closest('.superset-container');
                if (supersetContainer && parseInt(supersetContainer.dataset.supersetId) !== touchState.data) {
                    const rect = supersetContainer.getBoundingClientRect();
                    const midpoint = rect.top + rect.height / 2;
                    if (y < midpoint) {
                        supersetContainer.classList.add('drag-over-top');
                    }
                }
            } else if (touchState.type === 'exercise') {
                // Reordering exercises
                const exerciseElement = element.closest('.workout-exercise');
                const exercisesContainer = element.closest('.superset-exercises');

                if (exerciseElement) {
                    const currentExerciseId = parseInt(exerciseElement.dataset.exerciseId);
                    if (currentExerciseId !== touchState.data.exerciseId) {
                        const rect = exerciseElement.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;
                        if (y < midpoint) {
                            exerciseElement.classList.add('drag-over-top');
                        }
                    }
                } else if (exercisesContainer && !exerciseElement) {
                    exercisesContainer.classList.add('drag-over');
                }
            }
        }

        function handleTouchEnd(e) {
            if (!touchState.active) return;

            const touch = getTouchPoint(e);
            const element = getElementAtPoint(touch.clientX, touch.clientY);

            // Restore source element opacity
            if (touchState.sourceElement) {
                touchState.sourceElement.style.opacity = '';
            }

            // Process the drop
            if (element && touchState.clone) {
                processTouchDrop(element, touch.clientX, touch.clientY);
            }

            // Clear drop indicators
            document.querySelectorAll('.superset-container').forEach(el => {
                el.classList.remove('drag-over-top');
            });
            document.querySelectorAll('.workout-exercise').forEach(el => {
                el.classList.remove('drag-over-top');
            });
            document.querySelectorAll('.superset-exercises').forEach(el => {
                el.classList.remove('drag-over');
            });
            dropZone.classList.remove('drag-over');

            // Clean up
            removeTouchClone();
            touchState.active = false;
            touchState.type = null;
            touchState.data = null;
            touchState.sourceElement = null;
        }

        function processTouchDrop(element, x, y) {
            if (touchState.type === 'superset-type') {
                const supersetContainer = element.closest('.superset-container');
                if (!supersetContainer && element.closest('.drop-zone')) {
                    // Drop on empty space - add to end
                    addSupersetToWorkout(touchState.data);
                } else if (supersetContainer) {
                    // Drop on/between supersets - insert at position
                    const targetId = parseInt(supersetContainer.dataset.supersetId);
                    const rect = supersetContainer.getBoundingClientRect();
                    const midpoint = rect.top + rect.height / 2;
                    const dropBefore = y < midpoint;

                    const newSuperset = {
                        id: supersetCounter++,
                        type: touchState.data,
                        title: '',
                        config: { ...touchState.data.defaults },
                        exercises: []
                    };

                    const targetIndex = workoutSupersets.findIndex(s => s.id === targetId);
                    const insertIndex = dropBefore ? targetIndex : targetIndex + 1;
                    workoutSupersets.splice(insertIndex, 0, newSuperset);
                    renderWorkout();
                    debouncedUpdateURL();
                }
            } else if (touchState.type === 'exercise-pill') {
                const exerciseElement = element.closest('.workout-exercise');
                const exercisesContainer = element.closest('.superset-exercises');

                if (exerciseElement) {
                    // Drop on exercise - insert at position
                    const targetExerciseId = parseInt(exerciseElement.dataset.exerciseId);
                    const targetSupersetId = parseInt(exerciseElement.dataset.supersetId);
                    const targetSuperset = workoutSupersets.find(s => s.id === targetSupersetId);

                    if (targetSuperset) {
                        const rect = exerciseElement.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;
                        const dropBefore = y < midpoint;

                        const newExercise = {
                            id: exerciseCounter++,
                            ...touchState.data,
                            reps: '',
                            weight: ''
                        };

                        const targetIndex = targetSuperset.exercises.findIndex(ex => ex.id === targetExerciseId);
                        const insertIndex = dropBefore ? targetIndex : targetIndex + 1;
                        targetSuperset.exercises.splice(insertIndex, 0, newExercise);
                        renderWorkout();
                        debouncedUpdateURL();
                    }
                } else if (exercisesContainer) {
                    // Drop on empty container - add to end
                    const supersetId = parseInt(exercisesContainer.dataset.supersetId);
                    const superset = workoutSupersets.find(s => s.id === supersetId);

                    if (superset) {
                        const newExercise = {
                            id: exerciseCounter++,
                            ...touchState.data,
                            reps: '',
                            weight: ''
                        };
                        superset.exercises.push(newExercise);
                        renderWorkout();
                        debouncedUpdateURL();
                    }
                }
            } else if (touchState.type === 'superset') {
                const supersetContainer = element.closest('.superset-container');
                if (supersetContainer) {
                    const targetId = parseInt(supersetContainer.dataset.supersetId);
                    if (targetId !== touchState.data) {
                        const rect = supersetContainer.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;
                        const dropBefore = y < midpoint;

                        const draggedIndex = workoutSupersets.findIndex(s => s.id === touchState.data);
                        const [removed] = workoutSupersets.splice(draggedIndex, 1);

                        const newTargetIndex = workoutSupersets.findIndex(s => s.id === targetId);
                        const insertIndex = dropBefore ? newTargetIndex : newTargetIndex + 1;

                        workoutSupersets.splice(insertIndex, 0, removed);
                        renderWorkout();
                        debouncedUpdateURL();
                    }
                }
            } else if (touchState.type === 'exercise') {
                const exerciseElement = element.closest('.workout-exercise');
                const exercisesContainer = element.closest('.superset-exercises');

                if (exerciseElement) {
                    // Drop on exercise - insert at position
                    const targetExerciseId = parseInt(exerciseElement.dataset.exerciseId);
                    const targetSupersetId = parseInt(exerciseElement.dataset.supersetId);
                    const targetSuperset = workoutSupersets.find(s => s.id === targetSupersetId);

                    if (targetSuperset && targetExerciseId !== touchState.data.exerciseId) {
                        // Find source exercise
                        let sourceSuperset = null;
                        let sourceExercise = null;
                        let sourceIndex = -1;

                        for (const superset of workoutSupersets) {
                            const index = superset.exercises.findIndex(ex => ex.id === touchState.data.exerciseId);
                            if (index !== -1) {
                                sourceSuperset = superset;
                                sourceExercise = superset.exercises[index];
                                sourceIndex = index;
                                break;
                            }
                        }

                        if (sourceSuperset && sourceExercise) {
                            const rect = exerciseElement.getBoundingClientRect();
                            const midpoint = rect.top + rect.height / 2;
                            const dropBefore = y < midpoint;

                            sourceSuperset.exercises.splice(sourceIndex, 1);

                            let targetIndex = targetSuperset.exercises.findIndex(ex => ex.id === targetExerciseId);
                            if (sourceSuperset.id === targetSupersetId && sourceIndex < targetIndex) {
                                targetIndex--;
                            }

                            const insertIndex = dropBefore ? targetIndex : targetIndex + 1;
                            targetSuperset.exercises.splice(insertIndex, 0, sourceExercise);
                            renderWorkout();
                            debouncedUpdateURL();
                        }
                    }
                } else if (exercisesContainer) {
                    // Drop on empty container - move to end
                    const targetSupersetId = parseInt(exercisesContainer.dataset.supersetId);
                    const targetSuperset = workoutSupersets.find(s => s.id === targetSupersetId);

                    if (targetSuperset) {
                        // Find source exercise
                        let sourceSuperset = null;
                        let sourceExercise = null;
                        let sourceIndex = -1;

                        for (const superset of workoutSupersets) {
                            const index = superset.exercises.findIndex(ex => ex.id === touchState.data.exerciseId);
                            if (index !== -1) {
                                sourceSuperset = superset;
                                sourceExercise = superset.exercises[index];
                                sourceIndex = index;
                                break;
                            }
                        }

                        if (sourceSuperset && sourceExercise) {
                            sourceSuperset.exercises.splice(sourceIndex, 1);
                            targetSuperset.exercises.push(sourceExercise);
                            renderWorkout();
                            debouncedUpdateURL();
                        }
                    }
                }
            }
        }

        function addTouchHandlers() {
            // Add touch handlers to superset types
            const supersetTypesContainer = document.getElementById('supersetTypes');
            supersetTypesContainer.addEventListener('touchstart', (e) => {
                if (e.target.classList.contains('superset-type')) {
                    handleTouchStart(e, 'superset-type', e.target);
                }
            }, { passive: false });

            // Add touch handlers to exercise pills
            const catalogContainer = document.getElementById('catalog');
            catalogContainer.addEventListener('touchstart', (e) => {
                if (e.target.classList.contains('exercise-pill') && !e.target.classList.contains('disabled')) {
                    handleTouchStart(e, 'exercise-pill', e.target);
                }
            }, { passive: false });

            // Global touch move and end handlers
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: false });
            document.addEventListener('touchcancel', handleTouchEnd, { passive: false });
        }

        // Modified renderWorkout to add touch handlers to dynamically created elements
        const originalRenderWorkout = renderWorkout;
        renderWorkout = function() {
            originalRenderWorkout();

            // Add touch handlers to superset containers
            document.querySelectorAll('.superset-container').forEach(el => {
                const handle = el.querySelector('.superset-drag-handle');
                if (handle) {
                    handle.addEventListener('touchstart', (e) => {
                        handleTouchStart(e, 'superset', el);
                    }, { passive: false });
                }
            });

            // Add touch handlers to exercise elements
            document.querySelectorAll('.workout-exercise').forEach(el => {
                const handle = el.querySelector('.drag-handle');
                if (handle) {
                    handle.addEventListener('touchstart', (e) => {
                        handleTouchStart(e, 'exercise', el);
                    }, { passive: false });
                }
            });
        };

        // Initialize
        renderSupersetTypes();
        renderCatalog();
        addTouchHandlers();

        // Load workout from URL if present
        loadWorkoutFromURL();
    </script>
</body>
</html>
