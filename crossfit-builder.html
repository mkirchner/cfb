<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrossFit Workout Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: white;
            color: black;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            border-bottom: 2px solid black;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .workout-name {
            margin-top: 10px;
            padding: 8px;
            border: 1px solid black;
            border-radius: 4px;
            font-size: 16px;
            width: 300px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .panel {
            border: 2px solid black;
            border-radius: 4px;
            padding: 20px;
        }

        .panel h2 {
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid black;
        }

        /* Superset Catalog Styles */
        .superset-catalog {
            border: 2px solid black;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .superset-catalog h3 {
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .superset-types {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .superset-type {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border: 1px solid black;
            border-radius: 4px;
            cursor: move;
            background: white;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .superset-type:hover {
            background: #f5f5f5;
        }

        .superset-type.dragging {
            opacity: 0.5;
        }

        /* Exercise Catalog Styles */
        .catalog {
            max-height: 50vh;
            overflow-y: auto;
        }

        .exercise-category {
            margin-bottom: 20px;
        }

        .category-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .exercise-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid black;
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: move;
            background: white;
            transition: background 0.2s;
        }

        .exercise-item:hover {
            background: #f5f5f5;
        }

        .exercise-item.dragging {
            opacity: 0.5;
        }

        .exercise-icon {
            font-size: 20px;
            margin-right: 10px;
            width: 24px;
            text-align: center;
        }

        .exercise-name {
            flex: 1;
            font-size: 14px;
        }

        /* Workout Builder Styles */
        .workout-builder {
            min-height: 300px;
        }

        .drop-zone {
            min-height: 200px;
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .drop-zone.drag-over {
            background: #f5f5f5;
            border-color: black;
            border-style: solid;
        }

        .drop-zone-empty {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 14px;
        }

        /* Superset Container Styles */
        .superset-container {
            border: 2px solid black;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
            position: relative;
        }

        .superset-container::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            transition: background 0.2s;
        }

        .superset-container.drag-over-top::before {
            background: black;
            height: 4px;
        }

        .superset-container.dragging {
            opacity: 0.5;
        }

        .superset-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ccc;
        }

        .superset-drag-handle {
            cursor: move;
            margin-right: 8px;
            color: #666;
            font-size: 18px;
        }

        .superset-title {
            font-weight: 600;
            font-size: 16px;
            flex: 1;
        }

        .superset-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .superset-exercises {
            min-height: 60px;
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }

        .superset-exercises.drag-over {
            background: #f5f5f5;
            border-color: black;
            border-style: solid;
        }

        .superset-exercises-empty {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 13px;
        }

        /* Workout Exercise Styles */
        .workout-exercise {
            border: 1px solid black;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            cursor: move;
            position: relative;
        }

        .workout-exercise::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            transition: background 0.2s;
        }

        .workout-exercise.drag-over-top::before {
            background: black;
            height: 4px;
        }

        .workout-exercise.dragging {
            opacity: 0.5;
        }

        .workout-exercise-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .drag-handle {
            cursor: move;
            margin-right: 8px;
            color: #666;
            font-size: 18px;
        }

        .workout-exercise-header .exercise-icon {
            font-size: 18px;
        }

        .workout-exercise-header .exercise-name {
            font-weight: 600;
            font-size: 15px;
        }

        .exercise-actions {
            margin-left: auto;
            display: flex;
            gap: 5px;
        }

        .superset-actions {
            display: flex;
            gap: 5px;
        }

        .remove-btn, .duplicate-btn {
            background: black;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .duplicate-btn {
            background: white;
            color: black;
            border: 1px solid black;
        }

        .remove-btn:hover {
            background: #333;
        }

        .duplicate-btn:hover {
            background: #f5f5f5;
        }

        .workout-exercise-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .config-field {
            display: flex;
            flex-direction: column;
        }

        .config-field label {
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .config-field input {
            padding: 6px;
            border: 1px solid black;
            border-radius: 4px;
            font-size: 14px;
        }

        .actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid black;
            border-radius: 4px;
            background: black;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn:hover {
            background: #333;
        }

        .btn-secondary {
            background: white;
            color: black;
        }

        .btn-secondary:hover {
            background: #f5f5f5;
        }

        input:focus {
            outline: 2px solid black;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CrossFit Workout Builder</h1>
            <input type="text" class="workout-name" id="workoutName" placeholder="Workout name (e.g., WOD 2024-11-08)">
        </header>

        <div class="main-grid">
            <div class="panel workout-builder">
                <h2>Workout Builder</h2>
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-empty">Drag workout types here to build your workout</div>
                </div>
                <div class="actions">
                    <button class="btn" id="exportBtn">Export PDF</button>
                    <button class="btn btn-secondary" id="clearBtn">Clear Workout</button>
                </div>
            </div>

            <div class="panel">
                <h2>Exercise Catalog</h2>
                
                <div class="superset-catalog">
                    <h3>Workout Types</h3>
                    <div class="superset-types" id="supersetTypes"></div>
                </div>
                
                <div class="catalog" id="catalog"></div>
            </div>
        </div>
    </div>

    <script>
        const exercises = {
            "Cardio": [
                { name: "Rowing", icon: "ðŸš£" },
                { name: "Running", icon: "ðŸƒ" },
                { name: "Assault Bike", icon: "ðŸš´" },
                { name: "Jump Rope", icon: "ðŸª¢" },
                { name: "Burpees", icon: "ðŸ’¥" },
            ],
            "Weightlifting": [
                { name: "Deadlift", icon: "âš¡" },
                { name: "Back Squat", icon: "ðŸ¦µ" },
                { name: "Front Squat", icon: "ðŸ‹ï¸" },
                { name: "Clean", icon: "ðŸ’ª" },
                { name: "Snatch", icon: "ðŸŽ¯" },
                { name: "Clean & Jerk", icon: "ðŸ”¥" },
                { name: "Overhead Press", icon: "â¬†ï¸" },
                { name: "Push Press", icon: "ðŸ“ˆ" },
            ],
            "Gymnastics": [
                { name: "Pull-ups", icon: "â†‘" },
                { name: "Muscle-ups", icon: "â­•" },
                { name: "Handstand Push-ups", icon: "ðŸ¤¸" },
                { name: "Toes to Bar", icon: "ðŸŽª" },
                { name: "Box Jumps", icon: "ðŸ“¦" },
                { name: "Pistol Squats", icon: "ðŸ¦¿" },
            ],
            "Core": [
                { name: "Sit-ups", icon: "ðŸ”„" },
                { name: "Plank", icon: "â”" },
                { name: "Russian Twists", icon: "ðŸŒ€" },
                { name: "V-ups", icon: "âœ“" },
            ],
            "Other": [
                { name: "Wall Balls", icon: "ðŸ€" },
                { name: "Kettlebell Swings", icon: "âš«" },
                { name: "Thrusters", icon: "ðŸš€" },
                { name: "Rest", icon: "â¸ï¸" },
            ]
        };

        const supersetTypes = [
            { 
                name: "For Time", 
                fields: ["rounds", "timeEstimate"],
                defaults: { rounds: "1", timeEstimate: "" }
            },
            { 
                name: "AMRAP", 
                fields: ["duration", "timeEstimate"],
                defaults: { duration: "20", timeEstimate: "20" }
            },
            { 
                name: "EMOM", 
                fields: ["duration", "interval", "timeEstimate"],
                defaults: { duration: "20", interval: "1", timeEstimate: "20" }
            },
            { 
                name: "Chipper", 
                fields: ["timeEstimate"],
                defaults: { timeEstimate: "" }
            }
        ];

        let workoutSupersets = [];
        let supersetCounter = 0;
        let exerciseCounter = 0;

        // Drag state variables
        let draggedExerciseId = null;
        let draggedSupersetId = null;
        let draggedFromCatalog = false;
        let catalogExerciseData = null;
        let draggedSupersetType = null;

        function renderSupersetTypes() {
            const container = document.getElementById('supersetTypes');
            container.innerHTML = '';

            supersetTypes.forEach(type => {
                const div = document.createElement('div');
                div.className = 'superset-type';
                div.draggable = true;
                div.dataset.supersetType = JSON.stringify(type);
                div.textContent = type.name;

                div.addEventListener('dragstart', handleSupersetTypeDragStart);
                div.addEventListener('dragend', handleSupersetTypeDragEnd);

                container.appendChild(div);
            });
        }

        function renderCatalog() {
            const catalog = document.getElementById('catalog');
            catalog.innerHTML = '';

            for (const [category, items] of Object.entries(exercises)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'exercise-category';

                const title = document.createElement('div');
                title.className = 'category-title';
                title.textContent = category;
                categoryDiv.appendChild(title);

                items.forEach(exercise => {
                    const item = document.createElement('div');
                    item.className = 'exercise-item';
                    item.draggable = true;
                    item.dataset.exercise = JSON.stringify(exercise);

                    item.innerHTML = `
                        <span class="exercise-icon">${exercise.icon}</span>
                        <span class="exercise-name">${exercise.name}</span>
                    `;

                    item.addEventListener('dragstart', handleCatalogDragStart);
                    item.addEventListener('dragend', handleCatalogDragEnd);

                    categoryDiv.appendChild(item);
                });

                catalog.appendChild(categoryDiv);
            }
        }

        // Superset Type Drag Handlers
        function handleSupersetTypeDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
            draggedSupersetType = JSON.parse(e.target.dataset.supersetType);
        }

        function handleSupersetTypeDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedSupersetType = null;
        }

        // Catalog Drag Handlers
        function handleCatalogDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
            draggedFromCatalog = true;
            draggedExerciseId = null;
            draggedSupersetId = null;
            catalogExerciseData = JSON.parse(e.target.dataset.exercise);
        }

        function handleCatalogDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedFromCatalog = false;
            catalogExerciseData = null;
        }

        // Drop Zone Handlers
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            
            if (draggedSupersetType) {
                // Dropping a superset type
                const supersetElements = Array.from(dropZone.querySelectorAll('.superset-container'));
                const isOverSuperset = supersetElements.some(el => {
                    const rect = el.getBoundingClientRect();
                    return e.clientY >= rect.top && e.clientY <= rect.bottom;
                });
                
                if (!isOverSuperset) {
                    e.dataTransfer.dropEffect = 'copy';
                    dropZone.classList.add('drag-over');
                } else {
                    dropZone.classList.remove('drag-over');
                }
            }
        });

        dropZone.addEventListener('dragleave', (e) => {
            if (!dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('drag-over');
            }
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            if (draggedSupersetType) {
                // Check if dropped on empty space
                const supersetElements = Array.from(dropZone.querySelectorAll('.superset-container'));
                const isOverSuperset = supersetElements.some(el => {
                    const rect = el.getBoundingClientRect();
                    return e.clientY >= rect.top && e.clientY <= rect.bottom;
                });
                
                if (!isOverSuperset) {
                    addSupersetToWorkout(draggedSupersetType);
                }
            }
        });

        function addSupersetToWorkout(type) {
            const newSuperset = {
                id: supersetCounter++,
                type: type,
                config: { ...type.defaults },
                exercises: []
            };
            workoutSupersets.push(newSuperset);
            renderWorkout();
        }

        function renderWorkout() {
            const empty = dropZone.querySelector('.drop-zone-empty');
            
            if (workoutSupersets.length === 0) {
                if (!empty) {
                    dropZone.innerHTML = '<div class="drop-zone-empty">Drag workout types here to build your workout</div>';
                }
                return;
            }

            if (empty) {
                empty.remove();
            }

            const existingSupersets = dropZone.querySelectorAll('.superset-container');
            existingSupersets.forEach(el => el.remove());

            workoutSupersets.forEach((superset) => {
                const supersetDiv = document.createElement('div');
                supersetDiv.className = 'superset-container';
                supersetDiv.draggable = true;
                supersetDiv.dataset.supersetId = superset.id;

                // Build config fields HTML
                let configFieldsHTML = '';
                superset.type.fields.forEach(field => {
                    const label = field.charAt(0).toUpperCase() + field.slice(1).replace(/([A-Z])/g, ' $1');
                    const placeholder = getFieldPlaceholder(field);
                    configFieldsHTML += `
                        <div class="config-field">
                            <label>${label}</label>
                            <input type="text" value="${superset.config[field] || ''}" 
                                   onchange="updateSupersetConfig(${superset.id}, '${field}', this.value)"
                                   placeholder="${placeholder}">
                        </div>
                    `;
                });

                supersetDiv.innerHTML = `
                    <div class="superset-header">
                        <span class="superset-drag-handle">â‹®â‹®</span>
                        <span class="superset-title">${superset.type.name}</span>
                        <div class="superset-actions">
                            <button class="remove-btn" onclick="removeSuperset(${superset.id})">Remove</button>
                        </div>
                    </div>
                    <div class="superset-config">
                        ${configFieldsHTML}
                    </div>
                    <div class="superset-exercises" data-superset-id="${superset.id}">
                        ${superset.exercises.length === 0 ? '<div class="superset-exercises-empty">Drag exercises here</div>' : ''}
                    </div>
                `;

                supersetDiv.addEventListener('dragstart', handleSupersetDragStart);
                supersetDiv.addEventListener('dragend', handleSupersetDragEnd);
                supersetDiv.addEventListener('dragover', handleSupersetDragOver);
                supersetDiv.addEventListener('drop', handleSupersetDrop);
                supersetDiv.addEventListener('dragleave', handleSupersetDragLeave);

                dropZone.appendChild(supersetDiv);

                const exercisesContainer = supersetDiv.querySelector('.superset-exercises');
                
                superset.exercises.forEach((exercise) => {
                    const exerciseDiv = document.createElement('div');
                    exerciseDiv.className = 'workout-exercise';
                    exerciseDiv.draggable = true;
                    exerciseDiv.dataset.exerciseId = exercise.id;
                    exerciseDiv.dataset.supersetId = superset.id;

                    exerciseDiv.innerHTML = `
                        <div class="workout-exercise-header">
                            <span class="drag-handle">â‹®â‹®</span>
                            <span class="exercise-icon">${exercise.icon}</span>
                            <span class="exercise-name">${exercise.name}</span>
                            <div class="exercise-actions">
                                <button class="duplicate-btn" onclick="duplicateExercise(${superset.id}, ${exercise.id})">Duplicate</button>
                                <button class="remove-btn" onclick="removeExercise(${superset.id}, ${exercise.id})">Remove</button>
                            </div>
                        </div>
                        <div class="workout-exercise-config">
                            <div class="config-field">
                                <label>Reps</label>
                                <input type="text" value="${exercise.reps}" 
                                       onchange="updateExercise(${superset.id}, ${exercise.id}, 'reps', this.value)"
                                       placeholder="e.g., 10">
                            </div>
                            <div class="config-field">
                                <label>Weight</label>
                                <input type="text" value="${exercise.weight}" 
                                       onchange="updateExercise(${superset.id}, ${exercise.id}, 'weight', this.value)"
                                       placeholder="e.g., 135 lbs">
                            </div>
                        </div>
                    `;

                    exerciseDiv.addEventListener('dragstart', handleExerciseDragStart);
                    exerciseDiv.addEventListener('dragend', handleExerciseDragEnd);
                    exerciseDiv.addEventListener('dragover', handleExerciseDragOver);
                    exerciseDiv.addEventListener('drop', handleExerciseDrop);
                    exerciseDiv.addEventListener('dragleave', handleExerciseDragLeave);

                    if (exercisesContainer.querySelector('.superset-exercises-empty')) {
                        exercisesContainer.innerHTML = '';
                    }
                    exercisesContainer.appendChild(exerciseDiv);
                });

                exercisesContainer.addEventListener('dragover', handleExercisesContainerDragOver);
                exercisesContainer.addEventListener('drop', handleExercisesContainerDrop);
                exercisesContainer.addEventListener('dragleave', handleExercisesContainerDragLeave);
            });
        }

        function getFieldPlaceholder(field) {
            const placeholders = {
                'rounds': 'e.g., 3',
                'duration': 'minutes',
                'interval': 'minutes',
                'timeEstimate': 'minutes'
            };
            return placeholders[field] || '';
        }

        // Superset Drag Handlers
        function handleSupersetDragStart(e) {
            if (!e.target.classList.contains('superset-container')) return;
            draggedSupersetId = parseInt(e.currentTarget.dataset.supersetId);
            draggedExerciseId = null;
            draggedFromCatalog = false;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.stopPropagation();
        }

        function handleSupersetDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.superset-container').forEach(el => {
                el.classList.remove('drag-over-top');
            });
            draggedSupersetId = null;
        }

        function handleSupersetDragOver(e) {
            if (draggedSupersetId === null) return;
            e.preventDefault();
            e.stopPropagation();
            
            const rect = e.currentTarget.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            
            document.querySelectorAll('.superset-container').forEach(el => {
                el.classList.remove('drag-over-top');
            });
            
            if (e.clientY < midpoint) {
                e.currentTarget.classList.add('drag-over-top');
            }
            
            e.dataTransfer.dropEffect = 'move';
        }

        function handleSupersetDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drag-over-top');
            }
        }

        function handleSupersetDrop(e) {
            if (draggedSupersetId === null) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const dropTarget = e.currentTarget;
            const targetId = parseInt(dropTarget.dataset.supersetId);
            
            if (draggedSupersetId === targetId) {
                dropTarget.classList.remove('drag-over-top');
                return;
            }
            
            const rect = dropTarget.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            const dropBefore = e.clientY < midpoint;
            
            dropTarget.classList.remove('drag-over-top');
            
            const draggedIndex = workoutSupersets.findIndex(s => s.id === draggedSupersetId);
            const [removed] = workoutSupersets.splice(draggedIndex, 1);
            
            const newTargetIndex = workoutSupersets.findIndex(s => s.id === targetId);
            const insertIndex = dropBefore ? newTargetIndex : newTargetIndex + 1;
            
            workoutSupersets.splice(insertIndex, 0, removed);
            renderWorkout();
        }

        // Exercise Drag Handlers
        function handleExerciseDragStart(e) {
            if (!e.target.classList.contains('workout-exercise')) return;
            draggedExerciseId = parseInt(e.currentTarget.dataset.exerciseId);
            draggedSupersetId = null;
            draggedFromCatalog = false;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.stopPropagation();
        }

        function handleExerciseDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.workout-exercise').forEach(el => {
                el.classList.remove('drag-over-top');
            });
            document.querySelectorAll('.superset-exercises').forEach(el => {
                el.classList.remove('drag-over');
            });
            draggedExerciseId = null;
        }

        function handleExerciseDragOver(e) {
            if (draggedExerciseId === null && !draggedFromCatalog) return;
            e.preventDefault();
            e.stopPropagation();
            
            const rect = e.currentTarget.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            
            document.querySelectorAll('.workout-exercise').forEach(el => {
                el.classList.remove('drag-over-top');
            });
            
            if (e.clientY < midpoint) {
                e.currentTarget.classList.add('drag-over-top');
            }
            
            e.dataTransfer.dropEffect = draggedFromCatalog ? 'copy' : 'move';
        }

        function handleExerciseDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drag-over-top');
            }
        }

        function handleExerciseDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropTarget = e.currentTarget;
            const targetExerciseId = parseInt(dropTarget.dataset.exerciseId);
            const targetSupersetId = parseInt(dropTarget.dataset.supersetId);
            const targetSuperset = workoutSupersets.find(s => s.id === targetSupersetId);
            
            if (!targetSuperset) return;
            
            const rect = dropTarget.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            const dropBefore = e.clientY < midpoint;
            
            dropTarget.classList.remove('drag-over-top');
            
            const targetIndex = targetSuperset.exercises.findIndex(ex => ex.id === targetExerciseId);
            
            if (draggedFromCatalog && catalogExerciseData) {
                const newExercise = {
                    id: exerciseCounter++,
                    ...catalogExerciseData,
                    reps: '',
                    weight: ''
                };
                
                const insertIndex = dropBefore ? targetIndex : targetIndex + 1;
                targetSuperset.exercises.splice(insertIndex, 0, newExercise);
                
            } else if (draggedExerciseId !== null) {
                let sourceSuperset = null;
                let sourceExercise = null;
                let sourceIndex = -1;
                
                for (const superset of workoutSupersets) {
                    const index = superset.exercises.findIndex(ex => ex.id === draggedExerciseId);
                    if (index !== -1) {
                        sourceSuperset = superset;
                        sourceExercise = superset.exercises[index];
                        sourceIndex = index;
                        break;
                    }
                }
                
                if (!sourceSuperset || !sourceExercise) return;
                
                sourceSuperset.exercises.splice(sourceIndex, 1);
                
                let newTargetIndex = targetIndex;
                if (sourceSuperset.id === targetSupersetId && sourceIndex < targetIndex) {
                    newTargetIndex--;
                }
                
                const insertIndex = dropBefore ? newTargetIndex : newTargetIndex + 1;
                targetSuperset.exercises.splice(insertIndex, 0, sourceExercise);
            }
            
            renderWorkout();
        }

        // Exercise Container Drag Handlers
        function handleExercisesContainerDragOver(e) {
            if (!draggedFromCatalog || !catalogExerciseData) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const container = e.currentTarget;
            const exercises = Array.from(container.querySelectorAll('.workout-exercise'));
            
            const isOverExercise = exercises.some(el => {
                const rect = el.getBoundingClientRect();
                return e.clientY >= rect.top && e.clientY <= rect.bottom;
            });
            
            if (!isOverExercise) {
                container.classList.add('drag-over');
            } else {
                container.classList.remove('drag-over');
            }
        }

        function handleExercisesContainerDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drag-over');
            }
        }

        function handleExercisesContainerDrop(e) {
            if (!draggedFromCatalog || !catalogExerciseData) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const container = e.currentTarget;
            container.classList.remove('drag-over');
            
            const supersetId = parseInt(container.dataset.supersetId);
            const superset = workoutSupersets.find(s => s.id === supersetId);
            
            if (!superset) return;
            
            const exercises = Array.from(container.querySelectorAll('.workout-exercise'));
            const isOverExercise = exercises.some(el => {
                const rect = el.getBoundingClientRect();
                return e.clientY >= rect.top && e.clientY <= rect.bottom;
            });
            
            if (!isOverExercise) {
                const newExercise = {
                    id: exerciseCounter++,
                    ...catalogExerciseData,
                    reps: '',
                    weight: ''
                };
                superset.exercises.push(newExercise);
                renderWorkout();
            }
        }

        // Update/Remove Functions
        function updateSupersetConfig(supersetId, field, value) {
            const superset = workoutSupersets.find(s => s.id === supersetId);
            if (superset) {
                superset.config[field] = value;
            }
        }

        function removeSuperset(supersetId) {
            workoutSupersets = workoutSupersets.filter(s => s.id !== supersetId);
            renderWorkout();
        }

        function updateExercise(supersetId, exerciseId, field, value) {
            const superset = workoutSupersets.find(s => s.id === supersetId);
            if (superset) {
                const exercise = superset.exercises.find(ex => ex.id === exerciseId);
                if (exercise) {
                    exercise[field] = value;
                }
            }
        }

        function removeExercise(supersetId, exerciseId) {
            const superset = workoutSupersets.find(s => s.id === supersetId);
            if (superset) {
                superset.exercises = superset.exercises.filter(ex => ex.id !== exerciseId);
                renderWorkout();
            }
        }

        function duplicateExercise(supersetId, exerciseId) {
            const superset = workoutSupersets.find(s => s.id === supersetId);
            if (superset) {
                const exercise = superset.exercises.find(ex => ex.id === exerciseId);
                if (exercise) {
                    const newExercise = {
                        ...exercise,
                        id: exerciseCounter++
                    };
                    const index = superset.exercises.findIndex(ex => ex.id === exerciseId);
                    superset.exercises.splice(index + 1, 0, newExercise);
                    renderWorkout();
                }
            }
        }

        // Button Handlers
        document.getElementById('clearBtn').addEventListener('click', () => {
            if (workoutSupersets.length === 0 || confirm('Clear all supersets from workout?')) {
                workoutSupersets = [];
                renderWorkout();
            }
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            if (workoutSupersets.length === 0) {
                alert('Add workout types and exercises before exporting');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const workoutName = document.getElementById('workoutName').value || 'CrossFit Workout';
            const date = new Date().toLocaleDateString();
            
            doc.setFontSize(20);
            doc.text(workoutName, 20, 20);
            
            doc.setFontSize(10);
            doc.text(date, 20, 28);
            
            doc.setLineWidth(0.5);
            doc.line(20, 32, 190, 32);
            
            let y = 45;
            
            workoutSupersets.forEach((superset, supersetIndex) => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`${supersetIndex + 1}. ${superset.type.name}`, 20, y);
                y += 7;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                const configDetails = [];
                for (const [key, value] of Object.entries(superset.config)) {
                    if (value) {
                        const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
                        configDetails.push(`${label}: ${value}`);
                    }
                }
                
                if (configDetails.length > 0) {
                    doc.text(configDetails.join(' | '), 25, y);
                    y += 5;
                }
                
                y += 3;
                
                superset.exercises.forEach((exercise, exerciseIndex) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.text(`  ${exercise.name}`, 25, y);
                    y += 5;
                    
                    const details = [];
                    if (exercise.reps) details.push(`Reps: ${exercise.reps}`);
                    if (exercise.weight) details.push(`Weight: ${exercise.weight}`);
                    
                    if (details.length > 0) {
                        doc.setFontSize(9);
                        doc.text(details.join(' | '), 30, y);
                        doc.setFontSize(10);
                        y += 5;
                    }
                });
                
                y += 8;
            });
            
            doc.save(`${workoutName.replace(/\s+/g, '-').toLowerCase()}.pdf`);
        });

        // Initialize
        renderSupersetTypes();
        renderCatalog();
    </script>
</body>
</html>
